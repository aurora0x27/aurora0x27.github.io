
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>Mirai源码读后感III | 清风之恋の小窝</title>
    <meta name="author" content="清风之恋" />
    <meta name="description" content="ええ...?被找到了呢,这里会不定期更新一些好玩的东西哦" />
    <meta name="keywords" content="清风之恋,aurora0x27,aurora" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/nachoneko.png" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/vs.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>清风之恋の小窝</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;清风之恋の小窝</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>Mirai源码读后感III</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/8/12
        </span>
        
        <span class="category">
            <a href="/categories/Mirai%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                Mirai源码分析
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/%E5%90%B9%E6%B0%B4/" style="color: #00bcd4">
                    吹水
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        
    <div id="toc">
        <strong class="sidebar-title">目录</strong>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%8E%A7%E5%88%B6%E7%AB%AFcnc%E9%83%A8%E5%88%86-%E4%B8%8D%E5%A4%AA%E4%BC%9Agolang-T-T"><span class="toc-text">4. 控制端cnc部分 (不太会golang T^T)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-tools%E9%83%A8%E5%88%86"><span class="toc-text">5. tools部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-enc-c-%E2%80%93-%E5%8A%A0%E5%AF%86%E5%87%BD%E6%95%B0"><span class="toc-text">5.1 enc.c – 加密函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-nogdb-c-%E2%80%93-%E9%98%B2%E6%AD%A2gdb%E8%B0%83%E8%AF%95"><span class="toc-text">5.2 nogdb.c – 防止gdb调试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC"><span class="toc-text">6. 代码风格</span></a></li></ol>
    </div>


        <p>Mirai源码分析第三部分(太长了QAQ)</p>
<span id="more"></span>

<a href="/2024/08/12/MiraiSourceCodeNotes1/" title="Mirai源码读后感II">上一篇</a>

<h2 id="4-控制端cnc部分-不太会golang-T-T"><a href="#4-控制端cnc部分-不太会golang-T-T" class="headerlink" title="4. 控制端cnc部分 (不太会golang T^T)"></a>4. 控制端cnc部分 (不太会golang T^T)</h2><p>cnc部分是Mirai的控制端, 主要维护数据库, 以及下达攻击指令. 目录结构如下</p>
<pre><code>mirai/cnc/
├── admin.go     ---&gt; 处理管理员登陆, 创建新用户和初始化
├── api.go       ---&gt; 向感染的节点发送命令
├── attack.go    ---&gt; 处理用户攻击请求
├── bot.go       ---&gt; bot定义和Handle()函数
├── clientList.go---&gt; 维护受感染的节点
├── constants.go ---&gt; 一段乱码, 只在这一个文件中出现, 不知道有什么用
├── database.go  ---&gt; 包括用户登录验证, 新建用户, 处理白名单等的数据库管理
└── main.go      ---&gt; 入口函数, 解析命令行参数, 确定Mirai运行扫描还是攻击的模式
</code></pre>
<blockquote>
<p>Notice<br>还在更新</p>
</blockquote>
<h2 id="5-tools部分"><a href="#5-tools部分" class="headerlink" title="5. tools部分"></a>5. tools部分</h2><p>这个部分包含了一些工具性质的代码, 每个文件自己就可以编译成一个可执行文件</p>
<pre><code>mirai/tools
├── badbot.c ------&gt; 里面有一个死循环sleep, 不知道有什么用
├── enc.c    ------&gt; 关键的加密函数
├── nogdb.c  ------&gt; 修改ELF文件头, 使得gdb无法进行调试
├── scanListen.go--&gt; 监听来自被感染设备发回的信息
├── single_load.c--&gt; 也是loader的实现
└── wget.c   ------&gt; 下载文件用的, loader会使用
</code></pre>
<h3 id="5-1-enc-c-–-加密函数"><a href="#5-1-enc-c-–-加密函数" class="headerlink" title="5.1 enc.c – 加密函数"></a>5.1 enc.c – 加密函数</h3><h3 id="5-2-nogdb-c-–-防止gdb调试"><a href="#5-2-nogdb-c-–-防止gdb调试" class="headerlink" title="5.2 nogdb.c – 防止gdb调试"></a>5.2 nogdb.c – 防止gdb调试</h3><p>nogdb.c实现了一个修改ELF文件头来达到防止gdb调试的小程序.</p>
<p>ELF是Linux下可执行文件的格式(类似于Windows下的PE格式), 他不是一种单一的格式, 而是一类格式的统称. 不同的系统采用不同种类的ELF可执行文件格式,例如Linux ELF和BSD ELF不能兼容. </p>
<p>首先了解一下ELF文件头的结构, 这里编写了一个小型的hello程序, 之后做实验要用:</p>
<pre><code class="c">// 这是elf.h中对ELF文件头的定义
typedef struct
&#123;
  unsigned char	e_ident[EI_NIDENT];	/* Magic number and other info */
  Elf32_Half	e_type;			/* Object file type */
  Elf32_Half	e_machine;		/* Architecture */
  Elf32_Word	e_version;		/* Object file version */
  Elf32_Addr	e_entry;		/* Entry point virtual address */
  Elf32_Off	e_phoff;		/* Program header table file offset */
  Elf32_Off	e_shoff;		/* Section header table file offset */
  Elf32_Word	e_flags;		/* Processor-specific flags */
  Elf32_Half	e_ehsize;		/* ELF header size in bytes */
  Elf32_Half	e_phentsize;		/* Program header table entry size */
  Elf32_Half	e_phnum;		/* Program header table entry count */
  Elf32_Half	e_shentsize;		/* Section header table entry size */
  Elf32_Half	e_shnum;		/* Section header table entry count */
  Elf32_Half	e_shstrndx;		/* Section header string table index */
&#125; Elf32_Ehdr;
</code></pre>
<p>测试程序源码</p>
<pre><code class="c">#include &lt;stdio.h&gt;

int main(int argc, char** argv) &#123;
    printf(&quot;hello\n&quot;);
    return 0;
&#125;
</code></pre>
<p>执行<code>clang -g hello.c -o hello</code>进行编译, 并使用<code>readelf</code>读取ELF文件头</p>
<pre><code class="sh">    [aurora@archlinux] ~/Desktop/notes/mirai_analyse  
    &gt; readelf -h ./hello
    ELF 头：
      Magic：  7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
      类别:                              ELF64
      数据:                              2 补码，小端序 (little endian)
      Version:                           1 (current)
      OS/ABI:                            UNIX - System V
      ABI 版本:                          0
      类型:                              DYN (Position-Independent Executable file)
      系统架构:                          Advanced Micro Devices X86-64
      版本:                              0x1
      入口点地址：              0x1040
here-&gt;程序头起点：              64 (bytes into file) # 记住这一行,之后要考
      Start of section headers:          14176 (bytes into file)
      标志：             0x0
      Size of this header:               64 (bytes)
      Size of program headers:           56 (bytes)
      Number of program headers:         13
      Size of section headers:           64 (bytes)
      Number of section headers:         37
      Section header string table index: 36
</code></pre>
<p>此时执行 <code>gdb ./hello</code> , 可以正常的调试</p>
<p>编译 <code>nogdb.c</code> 得到可执行文件, 执行 <code>./nogdb ./hello</code> 对 <code>hello</code> 进行处理, 发现不能使用gdb调试(识别不出可执行文件):</p>
<pre><code class="sh">    [aurora@archlinux] ~/Desktop/notes/mirai_analyse  
    &gt; gdb ./hello
    GNU gdb (GDB) 15.1
    Copyright (C) 2024 Free Software Foundation, Inc.
    License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
    This is free software: you are free to change and redistribute it.
    There is NO WARRANTY, to the extent permitted by law.
    Type &quot;show copying&quot; and &quot;show warranty&quot; for details.
    This GDB was configured as &quot;x86_64-pc-linux-gnu&quot;.
    Type &quot;show configuration&quot; for configuration details.
    For bug reporting instructions, please see:
    &lt;https://www.gnu.org/software/gdb/bugs/&gt;.
    Find the GDB manual and other documentation resources online at:
        &lt;http://www.gnu.org/software/gdb/documentation/&gt;.

    For help, type &quot;help&quot;.
    Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...
    Registered pretty printers for UE classes
    Registered pretty printers for UE classes
    Registered pretty printers for UE classes
  -&gt;&quot;/home/aurora/Desktop/notes/mirai_analyse/./hello&quot;: not in executable format: file format not recognized
    (gdb) l
    No symbol table is loaded.  Use the &quot;file&quot; command.
</code></pre>
<p>再次使用<code>readelf</code>读取ELF文件头</p>
<pre><code class="sh">    [aurora@archlinux] ~/Desktop/notes/mirai_analyse  
    &gt; readelf -h ./hello
    ELF 头：
      Magic：  7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
      类别:                              ELF64
      数据:                              2 补码，小端序 (little endian)
      Version:                           1 (current)
      OS/ABI:                            UNIX - System V
      ABI 版本:                          0
    readelf：错误：Reading 728 bytes extends past end of file for 程序头
      类型:                              DYN (共享目标文件)
      系统架构:                          Advanced Micro Devices X86-64
      版本:                              0x1
      入口点地址：              0x1040
here-&gt;程序头起点：              65535 (bytes into file) # 这里产生了变化
      Start of section headers:          14176 (bytes into file)
      标志：             0xffffffff
      Size of this header:               64 (bytes)
      Size of program headers:           56 (bytes)
      Number of program headers:         13
      Size of section headers:           64 (bytes)
      Number of section headers:         37
      Section header string table index: 36
    readelf：错误：Reading 728 bytes extends past end of file for 程序头
</code></pre>
<p>阅读<code>nogdb</code>内部代码得知, 他修改了三个字段: 段表偏移地址, 节表偏移地址, 程序入口地址, 导致无法调试和执行</p>
<pre><code class="c">// elf文件头中的字段
//Elf32_Off	e_shoff;		/* Section header table file offset */
//Elf32_Half	e_phnum;		/* Program header table entry count */
//Elf32_Half	e_shstrndx;		/* Section header string table index */

// 源码中修改字段
header-&gt;e_shoff = 0xffff;
header-&gt;e_shnum = 0xffff;
header-&gt;e_shstrndx = 0xffff;
</code></pre>
<h2 id="6-代码风格"><a href="#6-代码风格" class="headerlink" title="6. 代码风格"></a>6. 代码风格</h2><blockquote>
<p>Notice<br>还在更新</p>
</blockquote>

    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 清风之恋の小窝
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;清风之恋
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    
<script
    src="https://giscus.app/client.js"
    data-repo="aurora0x27/aurora0x27.github.io"
    data-repo-id="R_kgDOMfB-WQ"
    data-category="Announcements"
    data-category-id="DIC_kwDOMfB-Wc4ChZUZ"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="zh-CN"
    crossorigin
    async
></script>





    
</body>
</html>
